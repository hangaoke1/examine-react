import{m as e,n as t,a,l as d,R as n,P as r,D as i,b as s,M as o,o as c,r as l,C as p,B as h,u as m,c as N,d as u}from"./vendor.584d5b1e.js";var E=e();function A(e,t,a){const d=["START","END","ROUTE","APPROVAL","ACTION"];t.data.children.forEach(((n,r)=>{d.includes(n.type)&&e.nodeList.push(Object.assign({type:n.type,id:n.id},n.data)),0===r?"CONDITION"===n.type&&O(e,null,n,a):O(e,t.data.children[r-1],n,a)}))}function O(e,a,d,n){const r={id:"",name:"",dstId:"",srcId:"",priority:1,conditionGroupList:[]};switch(d.type){case"APPROVAL":case"ACTION":["START","APPROVAL","ACTION"].includes(a.type)&&(Object.assign(r,{id:`LINE_${t(8)}`,srcId:a.id,dstId:d.id}),e.lineList.push(r));break;case"ROUTE":["START","APPROVAL","ACTION"].includes(a.type)&&(Object.assign(r,{id:`LINE_${t(8)}`,srcId:a.id,dstId:d.id}),e.lineList.push(r)),d.data.children.forEach((function(t){A(e,t,d)}));break;case"CONDITION":return r.id=d.id,r.srcId=n.id,r.priority=d.data.priority,r.name=d.data.name,r.conditionGroupList=d.data.conditionGroupList,void e.lineList.push(r);case"END":["START","APPROVAL","ACTION"].includes(a.type)&&(Object.assign(r,{id:`LINE_${t(8)}`,srcId:a.id,dstId:d.id}),e.lineList.push(r))}"CONDITION"===a.type&&(e.lineList.find((e=>e.id===a.id)).dstId=d.id),"ROUTE"===a.type&&T(e,a,d)}function T(e,a,d){a.data.children.forEach((a=>{const n=a.data.children,r=n[n.length-1],i={id:`LINE_${t(8)}`,dstId:d.id,srcId:r.id,priority:1,conditionGroupList:[]};"CONDITION"!==r.type?"ROUTE"!==r.type?e.lineList.push(i):T(e,r,d):e.lineList.forEach((e=>{e.id===r.id&&(e.dstId=d.id)}))}))}const y=e=>e.replace(/&/g,"&amp;").replace(/ /g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");class I{constructor({rootNode:e}={}){this.rootNode=e||this.initDefault(),this.nodeTypes=["START","END","APPROVAL","ACTION","ROUTE","BRANCH","CONDITION"],this.nodeTypeToTag={START:"start",END:"end",APPROVAL:"task",ACTION:"custom",ROUTE:"decision"},this.errorNodes=[],this.idNodeMap=new Map,this.idParentMap=new Map,this.typeNodeMap=new Map(this.nodeTypes.map((e=>[e,new Map]))),a(this),this.addDescendantsToMap(this.rootNode)}convertNode(e){return{}}buildXMLObject(e){const t=new Map,a={lineList:[],nodeList:[]},d={process:{_attributes:{displayName:y(e||"审批流程"),name:"process"}}};return A(a,this.rootNode),console.log("[debug] result",a),a.nodeList.forEach((e=>{const d={_attributes:{displayName:y(e.name),name:e.id}};("APPROVAL"===e.type||"ACTION"===e.type)&&(d._attributes=Object.assign(d._attributes,this.convertNode(e)));const n=a.lineList.filter((t=>t.srcId===e.id)).map((t=>{if("ROUTE"===e.type){const e=(t.conditionGroupList||[]).map((e=>e.map((e=>{this.convertNode(e)}))));return{_attributes:{displayName:y(t.name),name:t.id,expr:JSON.stringify(e),to:t.dstId}}}return{_attributes:{name:t.id,to:t.dstId}}}));n.length&&(d.transition=n);const r=t.get(e.type);t.set(e.type,Array.isArray(r)?[...r,d]:[d])})),t.forEach(((e,t)=>{const a=this.nodeTypeToTag[t];e.length&&(d.process[a]=e)})),d}buildXML(e){const t=this.buildXMLObject(e);return d.json2xml(t,{compact:!0,ignoreComment:!0,spaces:4})}initDefault(){const e=this.createStartNode(),t=this.createEndNode();return{id:"ROOT",type:"BRANCH",isError:!1,errors:[],data:{children:[e,this.createApprovalNode({parentBranchId:"ROOT"}),t]}}}addDescendantsToMap(e,t){this.addNodeToMap(e,t),e.data.children.forEach((t=>{this.addDescendantsToMap(t,e)}))}addNodeToMap(e,t){this.idNodeMap.set(e.id,e),this.idParentMap.set(e.id,t),this.typeNodeMap.get(e.type).set(e.id,e)}deleteDescendantsFromMap(e){this.deleteNodeFromMap(e),e.data.children.forEach((e=>{this.deleteDescendantsFromMap(e)}))}deleteNodeFromMap(e){this.idNodeMap.delete(e.id),this.idParentMap.delete(e.id),this.typeNodeMap.get(e.type).delete(e.id)}findNodeById(e){return this.findNodeRecursively(this.rootNode,e)}findNodeRecursively(e,t){if(e.id===t)return e;const a=e.data.children;for(let d=0;d<a.length;d++){const e=a[d],n=this.findNodeRecursively(e,t);if(n)return n}}createStartNode(){return{id:"START",type:"START",isError:!1,errors:[],parentBranchId:"ROOT",data:{children:[],name:"开始"}}}createEndNode(){return{id:"END",type:"END",isError:!1,errors:[],parentBranchId:"ROOT",data:{children:[],name:"结束"}}}createApprovalNode({parentBranchId:e}){return{id:`APPROVAL_${t(8)}`,type:"APPROVAL",isError:!1,errors:[],parentBranchId:e,data:{children:[],name:"审批"}}}createActionNode({parentBranchId:e}){return{id:`ACTION_${t(8)}`,type:"ACTION",isError:!1,errors:[],parentBranchId:e,data:{children:[],name:"动作"}}}createRouteNode({parentBranchId:e}){const a={id:`ROUTE_${t(8)}`,type:"ROUTE",isError:!1,errors:[],parentBranchId:e,data:{children:[],name:"路由"}};return a.data.children=new Array(2).fill("").map(((e,t)=>{const d=this.createBranchNode({parentRouteId:a.id}),n=this.createConditionNode({parentBranchId:d.id,isDefault:1===t,index:t+1});return d.data.children.push(n),d})),a}createBranchNode({parentRouteId:e}){return{id:`BRANCH_${t(8)}`,type:"BRANCH",isError:!1,errors:[],parentRouteId:e,data:{children:[],name:"分支"}}}createConditionNode({parentBranchId:e,isDefault:a,index:d=""}){return{id:`CONDITION_${t(8)}`,type:"CONDITION",isError:!1,errors:[],parentBranchId:e,data:{children:[],name:a?"默认":"条件节点"+d,isDefault:!!a}}}addNext(e,t){let a;const d=this.idParentMap.get(e),n=d.data.children.indexOf(this.idNodeMap.get(e))+1;"APPROVAL"===t?a=this.createApprovalNode({parentBranchId:d.id}):"ACTION"===t?a=this.createActionNode({parentBranchId:d.id}):"ROUTE"===t&&(a=this.createRouteNode({parentBranchId:d.id})),this.insertChild(a,d,n)}insertChild(e,t,a){t.data.children.splice(a,0,e),this.addDescendantsToMap(this.rootNode)}addChild(e,t,a){this.insertChild(e,t,void 0!==a?a:t.data.children.length)}addBranch(e){const t=this.idNodeMap.get(e),a=this.createBranchNode({parentRouteId:e}),d=this.createConditionNode({parentBranchId:a.id,index:t.data.children.length});a.data.children.push(d),this.addChild(a,t,t.data.children.length-1),this.updateConditionPriority(t)}moveCondition(e,t){const a=this.idNodeMap.get(e),d=this.idParentMap.get(a.id),n=this.idParentMap.get(d.id),r=n.data.children.indexOf(d),i=n.data.children[t];n.data.children[r]=i,n.data.children[t]=d,n.data.children=[...n.data.children],this.updateConditionPriority(n)}updateConditionPriority(e){e.data.children.forEach(((e,t)=>{e.data.children[0].data.priority=t+1}))}updateNodeData(e,t){this.idNodeMap.get(e).data=t}deleteNode(e){const t=this.idNodeMap.get(e);if(["APPROVAL","ACTION"].includes(t.type)){const a=this.idParentMap.get(e);a.data.children.splice(a.data.children.indexOf(t),1),this.deleteDescendantsFromMap(t)}if("CONDITION"===t.type){const t=this.idParentMap.get(e),a=this.idParentMap.get(t.id);if(a.data.children.length>2)a.data.children.splice(a.data.children.indexOf(t),1),this.deleteDescendantsFromMap(t),this.updateConditionPriority(a);else{const e=this.idParentMap.get(a.id);e.data.children.splice(e.data.children.indexOf(a),1),this.deleteDescendantsFromMap(a)}}}validate(){this.errorNodes=[],this.validateNode(this.rootNode)}validateNode(e){e.data.children.forEach((e=>{switch(e.type){case"START":e.isError=!this.validateStart(e);break;case"APPROVAL":e.isError=!this.validateApproval(e);break;case"ACTION":e.isError=!this.validateAction(e);break;case"CONDITION":e.isError=!this.validateCondition(e);break;case"END":e.isError=!this.validateEnd(e);break;case"BRANCH":case"ROUTE":this.validateNode(e)}e.isError&&this.errorNodes.push(e)}))}validateStart(e){return!0}validateEnd(e){return!0}validateApproval(e){return!0}validateAction(e){return!0}validateCondition(e){return!0}}const v=n.createContext(null);function f(e){const t=n.createElement(o,{onClick:t=>{return a=t.key,void e.onAdd(a);var a}},n.createElement(o.Item,{key:"APPROVAL"},"审批人"),n.createElement(o.Item,{key:"ROUTE"},"条件分支"),n.createElement(o.Item,{key:"ACTION"},"任务动作"));return n.createElement("div",{className:"add-node-btn"},n.createElement(i,{overlay:t,trigger:["click"]},n.createElement("div",{className:"add-node-reference"},n.createElement(s,null))))}function C(e){const{node:t,onAddBranch:a,onAdd:d}=e;return n.createElement("div",{className:"flow-route-node"},n.createElement("div",{className:"top-h-line"}),n.createElement("div",{className:"add-branch-btn",onClick:a},"添加条件"),n.createElement("div",{className:"branchs"},t.data.children.map(((e,a)=>n.createElement(P,{key:e.id,node:e,routeNode:t,branchIndex:a,branchCount:t.data.children.length})))),n.createElement("div",{className:"bottom-h-line"}),n.createElement("div",{className:"v-line"}),n.createElement(f,{onAdd:d}))}v.Provider,v.Consumer,f.propTypes={onAdd:r.func},C.propTypes={node:r.object};var R=c(C);function g(e){const{node:t,title:a,content:d,placeholder:r="请配置节点内容",closeable:i=!0,bgColor:s="#1890ff",titleColor:o="#fff"}=e,[c,m]=l.exports.useState(!1);return n.createElement("div",{className:"flow-editor-node"},n.createElement("div",{className:"flow-editor-node-container",style:{background:s},onClick:()=>{t&&E.emit("node_click",t)}},n.createElement("div",{className:"node-title",style:{color:o}},n.createElement("span",null,a)),n.createElement("div",{className:"node-content"},d?n.createElement("div",{className:"node-content__inner"},d):n.createElement("div",{className:"node-content__inner node-content__placeholder"},r)),e.children,i&&n.createElement(p,{className:"close-btn",onClick:()=>{m(!0)}}),c&&n.createElement("div",{className:"close-modal"},n.createElement(h,{size:"small",onClick:()=>{m(!1)}},"取消"),n.createElement(h,{size:"small",type:"primary",danger:!0,onClick:()=>{e.onDelete&&e.onDelete(),m(!1)}},"删除")),t.isError&&n.createElement("i",{className:"el-icon-warning"})),"END"!==t.type&&n.createElement(n.Fragment,null,n.createElement("div",{className:"v-line"}),n.createElement(f,{onAdd:t=>{e.onAdd&&e.onAdd(t)}})))}g.propTypes={node:r.object,title:r.string,content:r.string,placeholder:r.string,closeable:r.bool,bgColor:r.string,titleColor:r.string};const b=e=>{const{node:t}=e,a=l.exports.useContext(v),d=(e,t)=>{a.addNext(e.id,t)},r={START:"#a9b4cd",END:"#a9b4cd",CONDITION:"#52c41a",APPROVAL:"#faad14",ACTION:"#722ed1"};return n.createElement("div",{className:"flow-branch-node"},n.createElement("div",{className:"top-line-mask"}),n.createElement("div",{className:"top-v-line"}),n.createElement("div",{className:"nodes"},t.data.children.map((e=>"ROUTE"===e.type?n.createElement(R,{key:e.id,node:e,className:e.type,onAdd:t=>{d(e,t)},onAddBranch:()=>{var t;t=e,a.addBranch(t.id)}}):n.createElement(g,{key:e.id,node:e,className:e.type,title:e.data.name,bgColor:r[e.type],closeable:!["START","END"].includes(e.type)&&!e.data.isDefault,onAdd:t=>{d(e,t)},onDelete:()=>{var t;t=e,a.deleteNode(t.id)}})))),n.createElement("div",{className:"bottom-v-line"}),n.createElement("div",{className:"bottom-line-mask"}))};b.propTypes={node:r.object};var P=c(b);const M=c((()=>{const[e,t]=l.exports.useState(null),a=m({scale:1,showEdit:!1,editNode:null,showXml:!1,xmlContent:""}),d=e=>{a.editNode=e,a.showEdit=!0},r=e=>{"minus"===e?a.scale=a.scale-.1:"plus"===e&&(a.scale=a.scale+.1)};l.exports.useEffect((()=>{const e=new I;return t(e),window.flowStore=e,E.on("node_click",d),()=>{E.off("node_click",d)}}),[]);const i={transform:`scale(${a.scale})`};return n.createElement(v.Provider,{value:e},n.createElement("div",{className:"flow-editor"},n.createElement("div",{className:"flow-editor-toolbar"},n.createElement(h,{icon:n.createElement(N,null),disabled:a.scale<=.5,size:"small",onClick:()=>r("minus")}),n.createElement("span",{className:"flow-editor-toolbar__scale"},(100*a.scale).toFixed(0),"%"),n.createElement(h,{icon:n.createElement(s,null),disabled:a.scale>3,size:"small",onClick:()=>r("plus")})),n.createElement("div",{className:"flow-editor-view",style:i},e&&n.createElement(P,{node:e.rootNode}))))}));function D(){return n.createElement("div",{className:"App"},n.createElement(M,null))}u.render(n.createElement(n.StrictMode,null,n.createElement(D,null)),document.getElementById("root"));
