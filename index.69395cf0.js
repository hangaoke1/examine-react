var e=Object.defineProperty,t=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,r=(t,a,n)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[a]=n;import{m as d,n as i,a as o,t as s,l,R as c,P as p,D as h,b as m,M as u,o as N,r as E,C as y,B as C,c as O,d as v,e as b,I as g,u as I,_ as f,f as A,g as T,h as R,i as P,j as x,k as M}from"./vendor.8745a855.js";var w=d();function k(e,t,a){const n=["START","END","ROUTE","APPROVAL","ACTION"];t.data.children.forEach(((r,d)=>{n.includes(r.type)&&e.nodeList.push(Object.assign({type:r.type,id:r.id},r.data)),0===d?"CONDITION"===r.type&&D(e,null,r,a):D(e,t.data.children[d-1],r,a)}))}function D(e,t,a,n){const r={id:"",name:"",dstId:"",srcId:"",priority:1,conditionGroupList:[]};switch(a.type){case"APPROVAL":case"ACTION":["START","APPROVAL","ACTION"].includes(t.type)&&(Object.assign(r,{id:`LINE_${i(8)}`,srcId:t.id,dstId:a.id}),e.lineList.push(r));break;case"ROUTE":["START","APPROVAL","ACTION"].includes(t.type)&&(Object.assign(r,{id:`LINE_${i(8)}`,srcId:t.id,dstId:a.id}),e.lineList.push(r)),a.data.children.forEach((function(t){k(e,t,a)}));break;case"CONDITION":return r.id=a.id,r.srcId=n.id,r.priority=a.data.priority,r.name=a.data.name,r.conditionGroupList=a.data.conditionGroupList,void e.lineList.push(r);case"END":["START","APPROVAL","ACTION"].includes(t.type)&&(Object.assign(r,{id:`LINE_${i(8)}`,srcId:t.id,dstId:a.id}),e.lineList.push(r))}"CONDITION"===t.type&&(e.lineList.find((e=>e.id===t.id)).dstId=a.id),"ROUTE"===t.type&&L(e,t,a)}function L(e,t,a){t.data.children.forEach((t=>{const n=t.data.children,r=n[n.length-1],d={id:`LINE_${i(8)}`,dstId:a.id,srcId:r.id,priority:1,conditionGroupList:[]};"CONDITION"!==r.type?"ROUTE"!==r.type?e.lineList.push(d):L(e,r,a):e.lineList.forEach((e=>{e.id===r.id&&(e.dstId=a.id)}))}))}const B=e=>e.replace(/&/g,"&amp;").replace(/ /g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");class S{constructor({rootNode:e}={}){this.rootNode=e||this.initDefault(),this.nodeTypes=["START","END","APPROVAL","ACTION","ROUTE","BRANCH","CONDITION"],this.nodeTypeToTag={START:"start",END:"end",APPROVAL:"task",ACTION:"custom",ROUTE:"decision"},this.errorNodes=[],this.idNodeMap=new Map,this.idParentMap=new Map,this.typeNodeMap=new Map(this.nodeTypes.map((e=>[e,new Map]))),o(this),this.addDescendantsToMap(this.rootNode)}convertNode(e){return{}}buildXMLObject(e){const t=new Map,a={lineList:[],nodeList:[]},n={process:{_attributes:{displayName:B(e||"审批流程"),name:"process"}}};return k(a,s(this.rootNode)),console.log("[debug] result",a),a.nodeList.forEach((e=>{const n={_attributes:{displayName:B(e.name),name:e.id}};("APPROVAL"===e.type||"ACTION"===e.type)&&(n._attributes=Object.assign(n._attributes,this.convertNode(e)));const r=a.lineList.filter((t=>t.srcId===e.id)).map((t=>{if("ROUTE"===e.type){const e=(t.conditionGroupList||[]).map((e=>e.map((e=>{this.convertNode(e)}))));return{_attributes:{displayName:B(t.name),name:t.id,expr:JSON.stringify(e),to:t.dstId}}}return{_attributes:{name:t.id,to:t.dstId}}}));r.length&&(n.transition=r);const d=t.get(e.type);t.set(e.type,Array.isArray(d)?[...d,n]:[n])})),t.forEach(((e,t)=>{const a=this.nodeTypeToTag[t];e.length&&(n.process[a]=e)})),n}buildXML(e){const t=this.buildXMLObject(e);return l.json2xml(t,{compact:!0,ignoreComment:!0,spaces:4})}initDefault(){const e=this.createStartNode(),t=this.createEndNode();return{id:"ROOT",type:"BRANCH",isError:!1,errors:[],data:{children:[e,this.createApprovalNode({parentBranchId:"ROOT"}),t]}}}addDescendantsToMap(e,t){this.addNodeToMap(e,t),e.data.children.forEach((t=>{this.addDescendantsToMap(t,e)}))}addNodeToMap(e,t){this.idNodeMap.set(e.id,e),this.idParentMap.set(e.id,t),this.typeNodeMap.get(e.type).set(e.id,e)}deleteDescendantsFromMap(e){this.deleteNodeFromMap(e),e.data.children.forEach((e=>{this.deleteDescendantsFromMap(e)}))}deleteNodeFromMap(e){this.idNodeMap.delete(e.id),this.idParentMap.delete(e.id),this.typeNodeMap.get(e.type).delete(e.id)}findNodeById(e){return this.findNodeRecursively(this.rootNode,e)}findNodeRecursively(e,t){if(e.id===t)return e;const a=e.data.children;for(let n=0;n<a.length;n++){const e=a[n],r=this.findNodeRecursively(e,t);if(r)return r}}createStartNode(){return{id:"START",type:"START",isError:!1,errors:[],parentBranchId:"ROOT",data:{children:[],name:"开始"}}}createEndNode(){return{id:"END",type:"END",isError:!1,errors:[],parentBranchId:"ROOT",data:{children:[],name:"结束"}}}createApprovalNode({parentBranchId:e}){return{id:`APPROVAL_${i(8)}`,type:"APPROVAL",isError:!1,errors:[],parentBranchId:e,data:{children:[],name:"审批"}}}createActionNode({parentBranchId:e}){return{id:`ACTION_${i(8)}`,type:"ACTION",isError:!1,errors:[],parentBranchId:e,data:{children:[],name:"动作"}}}createRouteNode({parentBranchId:e}){const t={id:`ROUTE_${i(8)}`,type:"ROUTE",isError:!1,errors:[],parentBranchId:e,data:{children:[],name:"路由"}};return t.data.children=new Array(2).fill("").map(((e,a)=>{const n=this.createBranchNode({parentRouteId:t.id}),r=this.createConditionNode({parentBranchId:n.id,isDefault:1===a,index:a+1});return n.data.children.push(r),n})),t}createBranchNode({parentRouteId:e}){return{id:`BRANCH_${i(8)}`,type:"BRANCH",isError:!1,errors:[],parentRouteId:e,data:{children:[],name:"分支"}}}createConditionNode({parentBranchId:e,isDefault:t,index:a=""}){return{id:`CONDITION_${i(8)}`,type:"CONDITION",isError:!1,errors:[],parentBranchId:e,data:{children:[],name:t?"默认":"条件节点"+a,isDefault:!!t}}}addNext(e,t){let a;const n=this.idParentMap.get(e),r=n.data.children.indexOf(this.idNodeMap.get(e))+1;"APPROVAL"===t?a=this.createApprovalNode({parentBranchId:n.id}):"ACTION"===t?a=this.createActionNode({parentBranchId:n.id}):"ROUTE"===t&&(a=this.createRouteNode({parentBranchId:n.id})),this.insertChild(a,n,r)}insertChild(e,t,a){t.data.children.splice(a,0,e),this.addDescendantsToMap(this.rootNode)}addChild(e,t,a){this.insertChild(e,t,void 0!==a?a:t.data.children.length)}addBranch(e){const t=this.idNodeMap.get(e),a=this.createBranchNode({parentRouteId:e}),n=this.createConditionNode({parentBranchId:a.id,index:t.data.children.length});a.data.children.push(n),this.addChild(a,t,t.data.children.length-1),this.updateConditionPriority(t)}moveCondition(e,t){const a=this.idNodeMap.get(e),n=this.idParentMap.get(a.id),r=this.idParentMap.get(n.id),d=r.data.children.indexOf(n),i=r.data.children[t];r.data.children[d]=i,r.data.children[t]=n,r.data.children=[...r.data.children],this.updateConditionPriority(r)}updateConditionPriority(e){e.data.children.forEach(((e,t)=>{e.data.children[0].data.priority=t+1}))}updateNodeData(e,t){this.idNodeMap.get(e).data=t}deleteNode(e){const t=this.idNodeMap.get(e);if(["APPROVAL","ACTION"].includes(t.type)){const a=this.idParentMap.get(e);a.data.children.splice(a.data.children.indexOf(t),1),this.deleteDescendantsFromMap(t)}if("CONDITION"===t.type){const t=this.idParentMap.get(e),a=this.idParentMap.get(t.id);if(a.data.children.length>2)a.data.children.splice(a.data.children.indexOf(t),1),this.deleteDescendantsFromMap(t),this.updateConditionPriority(a);else{const e=this.idParentMap.get(a.id);e.data.children.splice(e.data.children.indexOf(a),1),this.deleteDescendantsFromMap(a)}}}validate(){this.errorNodes=[],this.validateNode(this.rootNode)}validateNode(e){e.data.children.forEach((e=>{switch(e.type){case"START":e.isError=!this.validateStart(e);break;case"APPROVAL":e.isError=!this.validateApproval(e);break;case"ACTION":e.isError=!this.validateAction(e);break;case"CONDITION":e.isError=!this.validateCondition(e);break;case"END":e.isError=!this.validateEnd(e);break;case"BRANCH":case"ROUTE":this.validateNode(e)}e.isError&&this.errorNodes.push(e)}))}validateStart(e){return!0}validateEnd(e){return!0}validateApproval(e){return!0}validateAction(e){return!0}validateCondition(e){return!0}}const _=c.createContext(null);function j(e){const t=c.createElement(u,{onClick:t=>{return a=t.key,void e.onAdd(a);var a}},c.createElement(u.Item,{key:"APPROVAL"},"审批人"),c.createElement(u.Item,{key:"ROUTE"},"条件分支"),c.createElement(u.Item,{key:"ACTION"},"任务动作"));return c.createElement("div",{className:"add-node-btn"},c.createElement(h,{overlay:t,trigger:["click"],transitionName:""},c.createElement("div",{className:"add-node-reference"},c.createElement(m,null))))}function V(e){const{node:t,onAddBranch:a,onAdd:n}=e;return c.createElement("div",{className:"flow-route-node"},c.createElement("div",{className:"top-h-line"}),c.createElement("div",{className:"add-branch-btn",onClick:a},"添加条件"),c.createElement("div",{className:"branchs"},t.data.children.map(((e,a)=>c.createElement(J,{key:e.id,node:e,routeNode:t,branchIndex:a,branchCount:t.data.children.length})))),c.createElement("div",{className:"bottom-h-line"}),c.createElement("div",{className:"v-line"}),c.createElement(j,{onAdd:n}))}_.Provider,_.Consumer,j.propTypes={onAdd:p.func},V.propTypes={node:p.object};var U=N(V);function X(e){const{node:t,title:a,content:n,placeholder:r="请配置节点内容",closeable:d=!0,bgColor:i="#1890ff",titleColor:o="#fff"}=e,[s,l]=E.exports.useState(!1);return c.createElement("div",{className:"flow-editor-node"},c.createElement("div",{className:"flow-editor-node-container",style:{background:i},onClick:()=>{t&&w.emit("node_click",t)}},c.createElement("div",{className:"node-title",style:{color:o}},c.createElement("span",null,a)),c.createElement("div",{className:"node-content"},n?c.createElement("div",{className:"node-content__inner"},n):c.createElement("div",{className:"node-content__inner node-content__placeholder"},r)),e.children,d&&c.createElement(y,{className:"close-btn",onClick:e=>{e.stopPropagation(),l(!0)}}),s&&c.createElement("div",{className:"close-modal"},c.createElement(C,{size:"small",onClick:e=>{e.stopPropagation(),l(!1)},style:{marginRight:5}},"取消"),c.createElement(C,{size:"small",type:"primary",danger:!0,onClick:t=>{t.stopPropagation(),e.onDelete&&e.onDelete(),l(!1)}},"删除")),t.isError&&c.createElement("i",{className:"el-icon-warning"})),"END"!==t.type&&c.createElement(c.Fragment,null,c.createElement("div",{className:"v-line"}),c.createElement(j,{onAdd:t=>{e.onAdd&&e.onAdd(t)}})))}function $(e){const d=e,{branchIndex:i,branchCount:o}=d,s=((e,r)=>{var d={};for(var i in e)a.call(e,i)&&r.indexOf(i)<0&&(d[i]=e[i]);if(null!=e&&t)for(var i of t(e))r.indexOf(i)<0&&n.call(e,i)&&(d[i]=e[i]);return d})(d,["branchIndex","branchCount"]),l=E.exports.useContext(_),p=E.exports.useMemo((()=>i!==o-1&&i>0),[i,o]),h=E.exports.useMemo((()=>i!==o-1&&i<o-2),[i,o]);return c.createElement(X,((e,d)=>{for(var i in d||(d={}))a.call(d,i)&&r(e,i,d[i]);if(t)for(var i of t(d))n.call(d,i)&&r(e,i,d[i]);return e})({},s),p&&c.createElement(O,{className:"arrow-left",onClick:t=>{t.stopPropagation(),l.moveCondition(e.node.id,i-1)}}),h&&c.createElement(v,{className:"arrow-right",onClick:t=>{t.stopPropagation(),l.moveCondition(e.node.id,i+1)}}))}X.propTypes={node:p.object,title:p.string,content:p.string,placeholder:p.string,closeable:p.bool,bgColor:p.string,titleColor:p.string},$.propTypes={branchIndex:p.number,branchCount:p.number};const F=e=>{const{node:t,branchIndex:a,branchCount:n}=e,r=E.exports.useContext(_),d=(e,t)=>{r.addNext(e.id,t)},i=e=>{r.deleteNode(e.id)},o={START:"#a9b4cd",END:"#a9b4cd",CONDITION:"#52c41a",APPROVAL:"#faad14",ACTION:"#722ed1"};return c.createElement("div",{className:"flow-branch-node"},c.createElement("div",{className:"top-line-mask"}),c.createElement("div",{className:"top-v-line"}),c.createElement("div",{className:"nodes"},t.data.children.map((e=>"ROUTE"===e.type?c.createElement(U,{key:e.id,node:e,className:e.type,onAdd:t=>{d(e,t)},onAddBranch:()=>{var t;t=e,r.addBranch(t.id)}}):"CONDITION"===e.type?c.createElement($,{key:e.id,node:e,className:e.type,title:e.data.name,bgColor:o[e.type],branchIndex:a,branchCount:n,closeable:!e.data.isDefault,onAdd:t=>{d(e,t)},onDelete:()=>{i(e)}}):c.createElement(X,{key:e.id,node:e,className:e.type,title:e.data.name,bgColor:o[e.type],closeable:!["START","END"].includes(e.type),onAdd:t=>{d(e,t)},onDelete:()=>{i(e)}})))),c.createElement("div",{className:"bottom-v-line"}),c.createElement("div",{className:"bottom-line-mask"}))};F.propTypes={node:p.object,branchIndex:p.number,branchCount:p.number};var J=N(F);function G(e){const{value:t,onChange:a,className:n}=e,[r,d]=E.exports.useState(!1);return c.createElement("div",{className:b("u-title",n),onClick:()=>{d(!0)}},r?c.createElement(g,{placeholder:"请输入节点名称",value:t,onChange:a,onBlur:()=>{d(!1)}}):c.createElement("span",null,t))}G.propTypes={className:p.string,disabled:p.bool,value:p.string,onChange:p.func};function H(e){const{node:t,visible:a,onClose:n}=e,r=I(),[d,i]=E.exports.useState(null),o=E.exports.useContext(_);return E.exports.useEffect((()=>{i(f.cloneDeep(t))}),[a]),c.createElement(A,{placement:"right",closable:!1,onClose:n,visible:a,width:500,bodyStyle:{padding:0}},d&&c.createElement("div",{className:"edit-panel"},c.createElement(G,{className:"edit-panel-title",value:d.data.name,onChange:e=>{const{value:t}=e.target;d.data.name=t,i(d),r()}}),c.createElement("div",{className:"edit-panel-content"},"自定义需要编辑的节点数据"),c.createElement("div",{className:"edit-panel-footer"},c.createElement(C,{onClick:n,style:{marginRight:10}},"取 消"),c.createElement(C,{type:"primary",onClick:()=>{o.updateNodeData(t.id,d.data),n()}},"确 定"))))}H.propTypes={node:p.object,visible:p.bool,onClose:p.func};const z=N((()=>{const[e,t]=E.exports.useState(null),a=T({scale:1,showEdit:!1,editNode:null,showXml:!1,xmlContent:"",showJson:!1,jsonContent:""}),n=e=>{a.editNode=e,a.showEdit=!0},r=e=>{"minus"===e?a.scale=a.scale-.1:"plus"===e&&(a.scale=a.scale+.1)};E.exports.useEffect((()=>{const e=new S;return t(e),window.flowStore=e,w.on("node_click",n),()=>{w.off("node_click",n)}}),[]);const d={transform:`scale(${a.scale})`};return c.createElement(_.Provider,{value:e},c.createElement("div",{className:"flow-editor"},c.createElement("div",{className:"flow-editor-toolbar"},c.createElement(C,{style:{padding:"4px 5px"},type:"link",onClick:()=>{a.showJson=!0,a.jsonContent=JSON.stringify(s(e.rootNode),null,2)}},"查看JSON"),c.createElement(C,{style:{padding:"4px 5px"},type:"link",onClick:()=>{a.showXml=!0,a.xmlContent=e.buildXML()}},"查看XML"),c.createElement(C,{icon:c.createElement(R,null),disabled:a.scale<=.5,size:"small",onClick:()=>r("minus")}),c.createElement("span",{className:"flow-editor-toolbar__scale"},(100*a.scale).toFixed(0),"%"),c.createElement(C,{icon:c.createElement(m,null),disabled:a.scale>3,size:"small",onClick:()=>r("plus")})),c.createElement("div",{className:"flow-editor-view",style:d},e&&c.createElement(J,{node:e.rootNode})),c.createElement(H,{visible:a.showEdit,node:a.editNode,onClose:()=>{a.showEdit=!1}}),c.createElement(P,{title:"XML数据预览",visible:a.showXml,width:"1000px",height:"600px",onOk:()=>{a.showXml=!1},onCancel:()=>{a.showXml=!1}},c.createElement(x,{width:"950",height:"600",language:"xml",theme:"vs-dark",value:a.xmlContent})),c.createElement(P,{title:"JSON数据预览",visible:a.showJson,width:"1000px",height:"600px",onOk:()=>{a.showJson=!1},onCancel:()=>{a.showJson=!1}},c.createElement(x,{width:"950",height:"600",language:"json",theme:"vs-dark",value:a.jsonContent}))))}));function q(){return c.createElement("div",{className:"App"},c.createElement(z,null))}M.render(c.createElement(q,null),document.getElementById("root"));
