import{m as e,n as t,a,t as n,l as d,R as r,P as i,D as s,b as o,M as l,o as c,r as p,C as h,B as m,c as N,I as u,u as E,_ as y,d as A,e as v,f as O,g as T}from"./vendor.d305eae9.js";var I=e();function C(e,t,a){const n=["START","END","ROUTE","APPROVAL","ACTION"];t.data.children.forEach(((d,r)=>{n.includes(d.type)&&e.nodeList.push(Object.assign({type:d.type,id:d.id},d.data)),0===r?"CONDITION"===d.type&&f(e,null,d,a):f(e,t.data.children[r-1],d,a)}))}function f(e,a,n,d){const r={id:"",name:"",dstId:"",srcId:"",priority:1,conditionGroupList:[]};switch(n.type){case"APPROVAL":case"ACTION":["START","APPROVAL","ACTION"].includes(a.type)&&(Object.assign(r,{id:`LINE_${t(8)}`,srcId:a.id,dstId:n.id}),e.lineList.push(r));break;case"ROUTE":["START","APPROVAL","ACTION"].includes(a.type)&&(Object.assign(r,{id:`LINE_${t(8)}`,srcId:a.id,dstId:n.id}),e.lineList.push(r)),n.data.children.forEach((function(t){C(e,t,n)}));break;case"CONDITION":return r.id=n.id,r.srcId=d.id,r.priority=n.data.priority,r.name=n.data.name,r.conditionGroupList=n.data.conditionGroupList,void e.lineList.push(r);case"END":["START","APPROVAL","ACTION"].includes(a.type)&&(Object.assign(r,{id:`LINE_${t(8)}`,srcId:a.id,dstId:n.id}),e.lineList.push(r))}"CONDITION"===a.type&&(e.lineList.find((e=>e.id===a.id)).dstId=n.id),"ROUTE"===a.type&&g(e,a,n)}function g(e,a,n){a.data.children.forEach((a=>{const d=a.data.children,r=d[d.length-1],i={id:`LINE_${t(8)}`,dstId:n.id,srcId:r.id,priority:1,conditionGroupList:[]};"CONDITION"!==r.type?"ROUTE"!==r.type?e.lineList.push(i):g(e,r,n):e.lineList.forEach((e=>{e.id===r.id&&(e.dstId=n.id)}))}))}const b=e=>e.replace(/&/g,"&amp;").replace(/ /g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");class R{constructor({rootNode:e}={}){this.rootNode=e||this.initDefault(),this.nodeTypes=["START","END","APPROVAL","ACTION","ROUTE","BRANCH","CONDITION"],this.nodeTypeToTag={START:"start",END:"end",APPROVAL:"task",ACTION:"custom",ROUTE:"decision"},this.errorNodes=[],this.idNodeMap=new Map,this.idParentMap=new Map,this.typeNodeMap=new Map(this.nodeTypes.map((e=>[e,new Map]))),a(this),this.addDescendantsToMap(this.rootNode)}convertNode(e){return{}}buildXMLObject(e){const t=new Map,a={lineList:[],nodeList:[]},d={process:{_attributes:{displayName:b(e||"审批流程"),name:"process"}}};return C(a,n(this.rootNode)),console.log("[debug] result",a),a.nodeList.forEach((e=>{const n={_attributes:{displayName:b(e.name),name:e.id}};("APPROVAL"===e.type||"ACTION"===e.type)&&(n._attributes=Object.assign(n._attributes,this.convertNode(e)));const d=a.lineList.filter((t=>t.srcId===e.id)).map((t=>{if("ROUTE"===e.type){const e=(t.conditionGroupList||[]).map((e=>e.map((e=>{this.convertNode(e)}))));return{_attributes:{displayName:b(t.name),name:t.id,expr:JSON.stringify(e),to:t.dstId}}}return{_attributes:{name:t.id,to:t.dstId}}}));d.length&&(n.transition=d);const r=t.get(e.type);t.set(e.type,Array.isArray(r)?[...r,n]:[n])})),t.forEach(((e,t)=>{const a=this.nodeTypeToTag[t];e.length&&(d.process[a]=e)})),d}buildXML(e){const t=this.buildXMLObject(e);return d.json2xml(t,{compact:!0,ignoreComment:!0,spaces:4})}initDefault(){const e=this.createStartNode(),t=this.createEndNode();return{id:"ROOT",type:"BRANCH",isError:!1,errors:[],data:{children:[e,this.createApprovalNode({parentBranchId:"ROOT"}),t]}}}addDescendantsToMap(e,t){this.addNodeToMap(e,t),e.data.children.forEach((t=>{this.addDescendantsToMap(t,e)}))}addNodeToMap(e,t){this.idNodeMap.set(e.id,e),this.idParentMap.set(e.id,t),this.typeNodeMap.get(e.type).set(e.id,e)}deleteDescendantsFromMap(e){this.deleteNodeFromMap(e),e.data.children.forEach((e=>{this.deleteDescendantsFromMap(e)}))}deleteNodeFromMap(e){this.idNodeMap.delete(e.id),this.idParentMap.delete(e.id),this.typeNodeMap.get(e.type).delete(e.id)}findNodeById(e){return this.findNodeRecursively(this.rootNode,e)}findNodeRecursively(e,t){if(e.id===t)return e;const a=e.data.children;for(let n=0;n<a.length;n++){const e=a[n],d=this.findNodeRecursively(e,t);if(d)return d}}createStartNode(){return{id:"START",type:"START",isError:!1,errors:[],parentBranchId:"ROOT",data:{children:[],name:"开始"}}}createEndNode(){return{id:"END",type:"END",isError:!1,errors:[],parentBranchId:"ROOT",data:{children:[],name:"结束"}}}createApprovalNode({parentBranchId:e}){return{id:`APPROVAL_${t(8)}`,type:"APPROVAL",isError:!1,errors:[],parentBranchId:e,data:{children:[],name:"审批"}}}createActionNode({parentBranchId:e}){return{id:`ACTION_${t(8)}`,type:"ACTION",isError:!1,errors:[],parentBranchId:e,data:{children:[],name:"动作"}}}createRouteNode({parentBranchId:e}){const a={id:`ROUTE_${t(8)}`,type:"ROUTE",isError:!1,errors:[],parentBranchId:e,data:{children:[],name:"路由"}};return a.data.children=new Array(2).fill("").map(((e,t)=>{const n=this.createBranchNode({parentRouteId:a.id}),d=this.createConditionNode({parentBranchId:n.id,isDefault:1===t,index:t+1});return n.data.children.push(d),n})),a}createBranchNode({parentRouteId:e}){return{id:`BRANCH_${t(8)}`,type:"BRANCH",isError:!1,errors:[],parentRouteId:e,data:{children:[],name:"分支"}}}createConditionNode({parentBranchId:e,isDefault:a,index:n=""}){return{id:`CONDITION_${t(8)}`,type:"CONDITION",isError:!1,errors:[],parentBranchId:e,data:{children:[],name:a?"默认":"条件节点"+n,isDefault:!!a}}}addNext(e,t){let a;const n=this.idParentMap.get(e),d=n.data.children.indexOf(this.idNodeMap.get(e))+1;"APPROVAL"===t?a=this.createApprovalNode({parentBranchId:n.id}):"ACTION"===t?a=this.createActionNode({parentBranchId:n.id}):"ROUTE"===t&&(a=this.createRouteNode({parentBranchId:n.id})),this.insertChild(a,n,d)}insertChild(e,t,a){t.data.children.splice(a,0,e),this.addDescendantsToMap(this.rootNode)}addChild(e,t,a){this.insertChild(e,t,void 0!==a?a:t.data.children.length)}addBranch(e){const t=this.idNodeMap.get(e),a=this.createBranchNode({parentRouteId:e}),n=this.createConditionNode({parentBranchId:a.id,index:t.data.children.length});a.data.children.push(n),this.addChild(a,t,t.data.children.length-1),this.updateConditionPriority(t)}moveCondition(e,t){const a=this.idNodeMap.get(e),n=this.idParentMap.get(a.id),d=this.idParentMap.get(n.id),r=d.data.children.indexOf(n),i=d.data.children[t];d.data.children[r]=i,d.data.children[t]=n,d.data.children=[...d.data.children],this.updateConditionPriority(d)}updateConditionPriority(e){e.data.children.forEach(((e,t)=>{e.data.children[0].data.priority=t+1}))}updateNodeData(e,t){this.idNodeMap.get(e).data=t}deleteNode(e){const t=this.idNodeMap.get(e);if(["APPROVAL","ACTION"].includes(t.type)){const a=this.idParentMap.get(e);a.data.children.splice(a.data.children.indexOf(t),1),this.deleteDescendantsFromMap(t)}if("CONDITION"===t.type){const t=this.idParentMap.get(e),a=this.idParentMap.get(t.id);if(a.data.children.length>2)a.data.children.splice(a.data.children.indexOf(t),1),this.deleteDescendantsFromMap(t),this.updateConditionPriority(a);else{const e=this.idParentMap.get(a.id);e.data.children.splice(e.data.children.indexOf(a),1),this.deleteDescendantsFromMap(a)}}}validate(){this.errorNodes=[],this.validateNode(this.rootNode)}validateNode(e){e.data.children.forEach((e=>{switch(e.type){case"START":e.isError=!this.validateStart(e);break;case"APPROVAL":e.isError=!this.validateApproval(e);break;case"ACTION":e.isError=!this.validateAction(e);break;case"CONDITION":e.isError=!this.validateCondition(e);break;case"END":e.isError=!this.validateEnd(e);break;case"BRANCH":case"ROUTE":this.validateNode(e)}e.isError&&this.errorNodes.push(e)}))}validateStart(e){return!0}validateEnd(e){return!0}validateApproval(e){return!0}validateAction(e){return!0}validateCondition(e){return!0}}const P=r.createContext(null);function M(e){const t=r.createElement(l,{onClick:t=>{return a=t.key,void e.onAdd(a);var a}},r.createElement(l.Item,{key:"APPROVAL"},"审批人"),r.createElement(l.Item,{key:"ROUTE"},"条件分支"),r.createElement(l.Item,{key:"ACTION"},"任务动作"));return r.createElement("div",{className:"add-node-btn"},r.createElement(s,{overlay:t,trigger:["click"],transitionName:""},r.createElement("div",{className:"add-node-reference"},r.createElement(o,null))))}function D(e){const{node:t,onAddBranch:a,onAdd:n}=e;return r.createElement("div",{className:"flow-route-node"},r.createElement("div",{className:"top-h-line"}),r.createElement("div",{className:"add-branch-btn",onClick:a},"添加条件"),r.createElement("div",{className:"branchs"},t.data.children.map(((e,a)=>r.createElement(w,{key:e.id,node:e,routeNode:t,branchIndex:a,branchCount:t.data.children.length})))),r.createElement("div",{className:"bottom-h-line"}),r.createElement("div",{className:"v-line"}),r.createElement(M,{onAdd:n}))}P.Provider,P.Consumer,M.propTypes={onAdd:i.func},D.propTypes={node:i.object};var L=c(D);function k(e){const{node:t,title:a,content:n,placeholder:d="请配置节点内容",closeable:i=!0,bgColor:s="#1890ff",titleColor:o="#fff"}=e,[l,c]=p.exports.useState(!1);return r.createElement("div",{className:"flow-editor-node"},r.createElement("div",{className:"flow-editor-node-container",style:{background:s},onClick:()=>{t&&I.emit("node_click",t)}},r.createElement("div",{className:"node-title",style:{color:o}},r.createElement("span",null,a)),r.createElement("div",{className:"node-content"},n?r.createElement("div",{className:"node-content__inner"},n):r.createElement("div",{className:"node-content__inner node-content__placeholder"},d)),e.children,i&&r.createElement(h,{className:"close-btn",onClick:()=>{c(!0)}}),l&&r.createElement("div",{className:"close-modal"},r.createElement(m,{size:"small",onClick:()=>{c(!1)},style:{marginRight:5}},"取消"),r.createElement(m,{size:"small",type:"primary",danger:!0,onClick:()=>{e.onDelete&&e.onDelete(),c(!1)}},"删除")),t.isError&&r.createElement("i",{className:"el-icon-warning"})),"END"!==t.type&&r.createElement(r.Fragment,null,r.createElement("div",{className:"v-line"}),r.createElement(M,{onAdd:t=>{e.onAdd&&e.onAdd(t)}})))}k.propTypes={node:i.object,title:i.string,content:i.string,placeholder:i.string,closeable:i.bool,bgColor:i.string,titleColor:i.string};const B=e=>{const{node:t}=e,a=p.exports.useContext(P),n=(e,t)=>{a.addNext(e.id,t)},d={START:"#a9b4cd",END:"#a9b4cd",CONDITION:"#52c41a",APPROVAL:"#faad14",ACTION:"#722ed1"};return r.createElement("div",{className:"flow-branch-node"},r.createElement("div",{className:"top-line-mask"}),r.createElement("div",{className:"top-v-line"}),r.createElement("div",{className:"nodes"},t.data.children.map((e=>"ROUTE"===e.type?r.createElement(L,{key:e.id,node:e,className:e.type,onAdd:t=>{n(e,t)},onAddBranch:()=>{var t;t=e,a.addBranch(t.id)}}):r.createElement(k,{key:e.id,node:e,className:e.type,title:e.data.name,bgColor:d[e.type],closeable:!["START","END"].includes(e.type)&&!e.data.isDefault,onAdd:t=>{n(e,t)},onDelete:()=>{var t;t=e,a.deleteNode(t.id)}})))),r.createElement("div",{className:"bottom-v-line"}),r.createElement("div",{className:"bottom-line-mask"}))};B.propTypes={node:i.object};var w=c(B);function x(e){const{value:t,onChange:a,className:n}=e,[d,i]=p.exports.useState(!1);return r.createElement("div",{className:N("u-title",n),onClick:()=>{i(!0)}},d?r.createElement(u,{placeholder:"请输入节点名称",value:t,onChange:a,onBlur:()=>{i(!1)}}):r.createElement("span",null,t))}x.propTypes={className:i.string,disabled:i.bool,value:i.string,onChange:i.func};function _(e){const{node:t,visible:a,onClose:n}=e,d=E(),[i,s]=p.exports.useState(null),o=p.exports.useContext(P);return p.exports.useEffect((()=>{s(y.cloneDeep(t))}),[a]),r.createElement(A,{placement:"right",closable:!1,onClose:n,visible:a,width:500,bodyStyle:{padding:0}},i&&r.createElement("div",{className:"edit-panel"},r.createElement(x,{className:"edit-panel-title",value:i.data.name,onChange:e=>{const{value:t}=e.target;i.data.name=t,s(i),d()}}),r.createElement("div",{className:"edit-panel-content"},"自定义需要编辑的节点数据"),r.createElement("div",{className:"edit-panel-footer"},r.createElement(m,{onClick:n,style:{marginRight:10}},"取 消"),r.createElement(m,{type:"primary",onClick:()=>{o.updateNodeData(t.id,i.data),n()}},"确 定"))))}_.propTypes={node:i.object,visible:i.bool,onClose:i.func};const S=c((()=>{const[e,t]=p.exports.useState(null),a=v({scale:1,showEdit:!1,editNode:null,showXml:!1,xmlContent:""}),n=e=>{a.editNode=e,a.showEdit=!0},d=e=>{"minus"===e?a.scale=a.scale-.1:"plus"===e&&(a.scale=a.scale+.1)};p.exports.useEffect((()=>{const e=new R;return t(e),window.flowStore=e,I.on("node_click",n),()=>{I.off("node_click",n)}}),[]);const i={transform:`scale(${a.scale})`};return r.createElement(P.Provider,{value:e},r.createElement("div",{className:"flow-editor"},r.createElement("div",{className:"flow-editor-toolbar"},r.createElement(m,{type:"link"},"查看XML"),r.createElement(m,{icon:r.createElement(O,null),disabled:a.scale<=.5,size:"small",onClick:()=>d("minus")}),r.createElement("span",{className:"flow-editor-toolbar__scale"},(100*a.scale).toFixed(0),"%"),r.createElement(m,{icon:r.createElement(o,null),disabled:a.scale>3,size:"small",onClick:()=>d("plus")})),r.createElement("div",{className:"flow-editor-view",style:i},e&&r.createElement(w,{node:e.rootNode})),r.createElement(_,{visible:a.showEdit,node:a.editNode,onClose:()=>{a.showEdit=!1}})))}));function V(){return r.createElement("div",{className:"App"},r.createElement(S,null))}T.render(r.createElement(r.StrictMode,null,r.createElement(V,null)),document.getElementById("root"));
